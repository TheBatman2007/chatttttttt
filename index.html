<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearby WiFi Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .status {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .section {
            padding: 20px;
        }

        .username-setup {
            text-align: center;
        }

        .username-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            margin: 10px 0;
            outline: none;
            transition: border-color 0.3s;
        }

        .username-input:focus {
            border-color: #667eea;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-create {
            background: #10b981;
        }

        .btn-create:hover:not(:disabled) {
            background: #059669;
        }

        .scanning-indicator {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .pulse {
            display: inline-block;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #667eea;
            animation: pulse 2s infinite;
            margin: 20px 0;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .code-box {
            background: #f3f4f6;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }
        
        .code-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .code {
            font-family: 'Courier New', monospace;
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            letter-spacing: 4px;
            user-select: all;
            margin: 10px 0;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .copy-btn:hover {
            background: #5568d3;
        }

        .input-group {
            margin: 15px 0;
        }
        
        .input-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        .code-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 24px;
            font-family: 'Courier New', monospace;
            text-align: center;
            letter-spacing: 3px;
            text-transform: uppercase;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .code-input:focus {
            border-color: #667eea;
        }

        .chat-container {
            height: 400px;
            display: flex;
            flex-direction: column;
            border-top: 1px solid #e0e0e0;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
        }
        
        .message {
            margin-bottom: 16px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-sent {
            text-align: right;
        }
        
        .message-bubble {
            display: inline-block;
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 16px;
            word-wrap: break-word;
        }
        
        .message-received .message-bubble {
            background: #e5e7eb;
            color: #1f2937;
            border-bottom-left-radius: 4px;
        }
        
        .message-sent .message-bubble {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 4px;
        }
        
        .input-area {
            padding: 16px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .message-input:focus {
            border-color: #667eea;
        }
        
        .btn-send {
            padding: 12px 20px;
            width: auto;
        }

        .btn-back {
            background: #6b7280;
        }

        .btn-back:hover {
            background: #4b5563;
        }

        .btn-disconnect {
            background: #ef4444;
        }

        .btn-disconnect:hover:not(:disabled) {
            background: #dc2626;
        }
        
        .alert {
            padding: 12px;
            margin: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .alert-error {
            background: #fee;
            color: #c33;
        }
        
        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .info-box {
            padding: 15px;
            text-align: center;
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            background: #f9fafb;
            border-radius: 8px;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }

        .peer-info {
            background: #f0f0f0;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 13px;
        }

        .peer-info strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“¡ Simple WiFi Chat</h1>
            <div class="status" id="status">Choose your role</div>
        </div>
        
        <div id="alertContainer"></div>
        
        <!-- Initial Screen -->
        <div id="initialScreen" class="section">
            <div class="info-box">
                <strong>ðŸ’¡ How it works:</strong>
                <br><br>
                One person creates a room and gets a code.<br>
                The other person joins using that code.<br>
                Then you can chat directly!
            </div>
            <button class="btn btn-create" id="createBtn">Create Room (I'll Share Code)</button>
            <button class="btn" id="showJoinBtn">Join Room (I Have a Code)</button>
        </div>

        <!-- Create Room Screen -->
        <div id="createScreen" class="section hidden">
            <div class="info-box">
                <strong>âœ… Room Created!</strong>
            </div>
            
            <div class="code-box">
                <div class="code-label">Share This Code</div>
                <div class="code" id="roomCode">----</div>
                <button class="copy-btn" id="copyBtn">ðŸ“‹ Copy Code</button>
            </div>

            <div class="peer-info">
                <strong>ðŸ“± Waiting for someone to join...</strong>
                <br>
                Share the code above with the other person
            </div>

            <button class="btn btn-back" id="cancelCreateBtn">Cancel</button>
        </div>

        <!-- Join Room Screen -->
        <div id="joinScreen" class="section hidden">
            <div class="info-box">
                <strong>Enter the 4-digit code</strong><br>
                shared by the room creator
            </div>
            
            <div class="input-group">
                <input type="text" class="code-input" id="joinCodeInput" placeholder="XXXX" maxlength="4">
            </div>

            <button class="btn" id="joinBtn">Join Room</button>
            <button class="btn btn-back" id="cancelJoinBtn">Back</button>
        </div>

        <!-- Chat Screen -->
        <div id="chatScreen" class="hidden">
            <div class="chat-container">
                <div class="messages" id="messages">
                    <div class="info-box">ðŸŽ‰ Connected! Start chatting...</div>
                </div>
                <div class="input-area">
                    <input type="text" class="message-input" id="messageInput" placeholder="Type a message..." maxlength="500">
                    <button class="btn btn-send" id="sendBtn">Send</button>
                </div>
            </div>

            <div class="section">
                <button class="btn btn-disconnect" id="disconnectBtn">Disconnect</button>
            </div>
        </div>
    </div>

    <script>
        // Use window.storage for persistent signaling
        const STORAGE_PREFIX = 'wifi_chat_';
        
        let peerConnection = null;
        let dataChannel = null;
        let isInitiator = false;
        let roomCode = '';
        let pollInterval = null;

        // WebRTC Configuration
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // UI Elements
        const initialScreen = document.getElementById('initialScreen');
        const createScreen = document.getElementById('createScreen');
        const joinScreen = document.getElementById('joinScreen');
        const chatScreen = document.getElementById('chatScreen');
        
        const createBtn = document.getElementById('createBtn');
        const showJoinBtn = document.getElementById('showJoinBtn');
        const joinBtn = document.getElementById('joinBtn');
        const cancelCreateBtn = document.getElementById('cancelCreateBtn');
        const cancelJoinBtn = document.getElementById('cancelJoinBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const copyBtn = document.getElementById('copyBtn');
        
        const roomCodeDiv = document.getElementById('roomCode');
        const joinCodeInput = document.getElementById('joinCodeInput');
        const messageInput = document.getElementById('messageInput');
        const messagesDiv = document.getElementById('messages');
        const statusDiv = document.getElementById('status');
        const alertContainer = document.getElementById('alertContainer');

        function showScreen(screen) {
            [initialScreen, createScreen, joinScreen, chatScreen].forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
        }

        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function updateStatus(status, color = '#fff') {
            statusDiv.textContent = status;
            statusDiv.style.color = color;
        }

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        async function createRoom() {
            try {
                isInitiator = true;
                roomCode = generateRoomCode();
                roomCodeDiv.textContent = roomCode;
                
                showScreen(createScreen);
                updateStatus('Waiting for peer...', '#ffd700');

                // Create peer connection
                peerConnection = new RTCPeerConnection(config);

                // Create data channel
                dataChannel = peerConnection.createDataChannel('chat');
                setupDataChannel();

                // Collect ICE candidates
                const candidates = [];
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        candidates.push(event.candidate);
                    }
                };

                // Create offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // Wait for ICE gathering to complete
                await new Promise(resolve => {
                    if (peerConnection.iceGatheringState === 'complete') {
                        resolve();
                    } else {
                        peerConnection.addEventListener('icegatheringstatechange', () => {
                            if (peerConnection.iceGatheringState === 'complete') {
                                resolve();
                            }
                        });
                    }
                });

                // Store offer with all candidates
                const offerData = {
                    offer: peerConnection.localDescription,
                    candidates: candidates,
                    timestamp: Date.now()
                };

                await window.storage.set(STORAGE_PREFIX + roomCode, JSON.stringify(offerData), true);
                
                showAlert('Room created! Share the code with the other person.', 'success');

                // Poll for answer
                pollForAnswer();

            } catch (error) {
                console.error('Create room error:', error);
                showAlert('Failed to create room: ' + error.message, 'error');
                showScreen(initialScreen);
            }
        }

        async function pollForAnswer() {
            pollInterval = setInterval(async () => {
                try {
                    const result = await window.storage.get(STORAGE_PREFIX + roomCode + '_answer', true);
                    
                    if (result && peerConnection) {
                        clearInterval(pollInterval);
                        
                        const answerData = JSON.parse(result.value);
                        
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answerData.answer));
                        
                        // Add remote ICE candidates
                        if (answerData.candidates) {
                            for (const candidate of answerData.candidates) {
                                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                            }
                        }
                        
                        updateStatus('Connected!', '#4ade80');
                        showAlert('Peer connected!', 'success');
                    }
                } catch (error) {
                    // Key doesn't exist yet, keep polling
                    console.log('Waiting for answer...');
                }
            }, 2000);

            // Timeout after 2 minutes
            setTimeout(() => {
                if (pollInterval) {
                    clearInterval(pollInterval);
                    if (!dataChannel || dataChannel.readyState !== 'open') {
                        showAlert('Connection timeout. Please try again.', 'error');
                        cleanup();
                        showScreen(initialScreen);
                    }
                }
            }, 120000);
        }

        async function joinRoom() {
            const code = joinCodeInput.value.trim().toUpperCase();
            
            if (code.length !== 4) {
                showAlert('Please enter a valid 4-character code', 'error');
                return;
            }

            try {
                updateStatus('Fetching room data...', '#ffd700');
                
                const result = await window.storage.get(STORAGE_PREFIX + code, true);
                
                if (!result) {
                    showAlert('Room not found. Check the code and try again.', 'error');
                    return;
                }

                const offerData = JSON.parse(result.value);
                
                isInitiator = false;
                roomCode = code;
                
                updateStatus('Connecting...', '#ffd700');

                // Create peer connection
                peerConnection = new RTCPeerConnection(config);

                // Handle incoming data channel
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel();
                };

                // Collect ICE candidates
                const answerCandidates = [];
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        answerCandidates.push(event.candidate);
                    }
                };

                // Set remote description (offer)
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offerData.offer));

                // Add remote ICE candidates
                if (offerData.candidates) {
                    for (const candidate of offerData.candidates) {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    }
                }

                // Create answer
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                // Wait for ICE gathering to complete
                await new Promise(resolve => {
                    if (peerConnection.iceGatheringState === 'complete') {
                        resolve();
                    } else {
                        peerConnection.addEventListener('icegatheringstatechange', () => {
                            if (peerConnection.iceGatheringState === 'complete') {
                                resolve();
                            }
                        });
                    }
                });

                // Store answer
                const answerData = {
                    answer: peerConnection.localDescription,
                    candidates: answerCandidates,
                    timestamp: Date.now()
                };

                await window.storage.set(STORAGE_PREFIX + code + '_answer', JSON.stringify(answerData), true);

                updateStatus('Waiting for connection...', '#ffd700');
                showAlert('Sent connection response!', 'success');

            } catch (error) {
                console.error('Join room error:', error);
                showAlert('Failed to join room: ' + error.message, 'error');
            }
        }

        function setupDataChannel() {
            dataChannel.onopen = () => {
                console.log('Data channel opened');
                updateStatus('Connected!', '#4ade80');
                showScreen(chatScreen);
                messagesDiv.innerHTML = '<div class="info-box">ðŸŽ‰ Connected! Start chatting...</div>';
                messageInput.focus();
                showAlert('Successfully connected!', 'success');
                
                if (pollInterval) {
                    clearInterval(pollInterval);
                }
            };

            dataChannel.onclose = () => {
                console.log('Data channel closed');
                updateStatus('Disconnected', '#ef4444');
                showAlert('Connection closed', 'error');
                cleanup();
                showScreen(initialScreen);
            };

            dataChannel.onmessage = (event) => {
                addMessage(event.data, false);
            };

            dataChannel.onerror = (error) => {
                console.error('Data channel error:', error);
                showAlert('Connection error', 'error');
            };
        }

        function addMessage(text, isSent = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isSent ? 'message-sent' : 'message-received'}`;
            
            const time = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            msgDiv.innerHTML = `
                <div class="message-bubble">${escapeHtml(text)}</div>
                <div class="message-time">${time}</div>
            `;
            
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            if (!dataChannel || dataChannel.readyState !== 'open') {
                showAlert('Not connected', 'error');
                return;
            }

            try {
                dataChannel.send(message);
                addMessage(message, true);
                messageInput.value = '';
                messageInput.focus();
            } catch (error) {
                console.error('Send error:', error);
                showAlert('Failed to send message', 'error');
            }
        }

        async function cleanup() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }

            if (dataChannel) {
                dataChannel.close();
                dataChannel = null;
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            if (roomCode) {
                try {
                    await window.storage.delete(STORAGE_PREFIX + roomCode, true);
                    await window.storage.delete(STORAGE_PREFIX + roomCode + '_answer', true);
                } catch (e) {
                    console.log('Cleanup error:', e);
                }
                roomCode = '';
            }

            isInitiator = false;
            updateStatus('Disconnected', '#ef4444');
        }

        // Event Listeners
        createBtn.addEventListener('click', createRoom);
        
        showJoinBtn.addEventListener('click', () => {
            showScreen(joinScreen);
            joinCodeInput.focus();
        });

        joinBtn.addEventListener('click', joinRoom);

        cancelCreateBtn.addEventListener('click', () => {
            cleanup();
            showScreen(initialScreen);
            updateStatus('Choose your role', '#fff');
        });

        cancelJoinBtn.addEventListener('click', () => {
            showScreen(initialScreen);
            updateStatus('Choose your role', '#fff');
        });

        disconnectBtn.addEventListener('click', () => {
            cleanup();
            showScreen(initialScreen);
            updateStatus('Choose your role', '#fff');
        });

        sendBtn.addEventListener('click', sendMessage);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(roomCode).then(() => {
                copyBtn.textContent = 'âœ“ Copied!';
                setTimeout(() => {
                    copyBtn.textContent = 'ðŸ“‹ Copy Code';
                }, 2000);
            }).catch(() => {
                showAlert('Copy failed. Manually copy: ' + roomCode, 'warning');
            });
        });

        joinCodeInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        // Check for storage support
        if (!window.storage) {
            showAlert('Persistent storage not available. This feature requires the Claude.ai environment.', 'error');
            createBtn.disabled = true;
            showJoinBtn.disabled = true;
        }
    </script>
</body>
</html>
